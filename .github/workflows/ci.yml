name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-matrix:
    name: Build (${{ matrix.distro }})
    runs-on: ubuntu-latest
    container: ${{ matrix.image }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: Ubuntu 22.04
            image: ubuntu:22.04
            pkg_manager: apt
          - distro: Ubuntu 24.04
            image: ubuntu:24.04
            pkg_manager: apt
          - distro: Debian 12
            image: debian:12
            pkg_manager: apt
          - distro: Debian 13
            image: debian:trixie
            pkg_manager: apt
          - distro: Fedora 40
            image: fedora:40
            pkg_manager: dnf

    steps:
      - name: Install git and wget
        run: |
          if [ "${{ matrix.pkg_manager }}" = "apt" ]; then
            apt-get update && apt-get install -y git wget ca-certificates
          else
            dnf install -y git wget ca-certificates
          fi

      - name: Checkout
        uses: actions/checkout@v6

      - name: Fix Git safe directory
        run: git config --global --add safe.directory '*'

      - name: Install Go 1.24
        run: |
          # Download and install Go 1.24.4
          wget -q https://go.dev/dl/go1.24.4.linux-amd64.tar.gz
          tar -C /usr/local -xzf go1.24.4.linux-amd64.tar.gz
          rm go1.24.4.linux-amd64.tar.gz
        
      - name: Verify Go installation
        run: /usr/local/go/bin/go version

      - name: Install dependencies (apt)
        if: matrix.pkg_manager == 'apt'
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          apt-get install -y \
            clang llvm libbpf-dev libelf-dev \
            make

      - name: Install dependencies (dnf)
        if: matrix.pkg_manager == 'dnf'
        run: |
          dnf install -y \
            clang llvm libbpf-devel elfutils-libelf-devel \
            make

      - name: Build BPF object
        run: make bpf/netleak.o

      - name: Build Go binary
        run: PATH=/usr/local/go/bin:$PATH make cmd

      - name: Verify artifacts
        run: |
          ls -lh netleak bpf/netleak.o
          test -x netleak
          test -f bpf/netleak.o

      - name: Run unit tests
        run: |
          cd tests/unit
          PATH=/usr/local/go/bin:$PATH go test -v ./...
        continue-on-error: true

  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'
          cache: true
          cache-dependency-path: go.sum

      - name: Go vet
        run: go vet ./cmd/...

      - name: Install staticcheck
        run: go install honnef.co/go/tools/cmd/staticcheck@latest

      - name: Staticcheck
        run: staticcheck ./cmd/...
